<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Woning Analyse ‚Äì Bergweg ‚Ä¢ Marktwaardemeter</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #f3f4f6; }
    .input-label { font-size: 12px; font-weight: 600; color: #555; }
  </style>
</head>

<body class="bg-gray-100">
  <div id="app" class="w-full max-w-6xl mx-auto p-6">

    <!-- TITEL -->
    <div class="bg-white p-6 shadow rounded mb-6">
      <h1 class="text-3xl font-bold">üè† Woningmarkt Analyse ‚Äì Bergweg Rotterdam</h1>
      <p class="text-gray-600 mt-1">
        Realtime analyse van <strong>vraagprijzen, m¬≤-prijzen, woningtypes en marktvergelijkingen</strong>.
      </p>
    </div>
<!-- FUNDA URL SCRAPER BLOK -->
<div class="bg-white p-6 shadow rounded mb-6">

  <h2 class="text-xl font-semibold mb-3">üîó Funda URL Import</h2>
  <p class="text-gray-600 mb-4">
    Plak hier een Funda zoek-URL om automatisch alle woningen te importeren.
  </p>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

    <div class="md:col-span-3">
      <label class="input-label">Funda zoek-URL</label>
      <input id="funda-url" type="text" class="w-full p-2 border rounded"
             placeholder="https://www.funda.nl/zoeken/koop?custom_area=....">
    </div>

    <div class="md:col-span-1">
      <label class="input-label"> </label>
      <button id="btn-scrape"
        class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded font-semibold">
        Scrape woningen
      </button>
    </div>
  </div>

  <!-- LOADER -->
  <div id="scrape-loader" class="hidden mt-4 text-gray-600 text-sm">
    ‚è≥ Bezig met ophalen... dit kan 3‚Äì8 seconden duren.
  </div>

  <!-- RESULTAAT -->
  <div id="scrape-status" class="mt-4 text-sm text-blue-700 font-semibold"></div>

</div>

    <!-- KPI CARDS -->
    <div id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

    <!-- Woning invoeren -->
    <div class="bg-white p-6 shadow rounded mb-6">
      <h2 class="text-xl font-semibold mb-4">üîç Vergelijk jouw woning</h2>

      <!-- BASISGEGEVENS -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">

        <!-- Woningtype -->
        <div>
          <label class="input-label">Woningtype</label>
          <select id="input-type" class="w-full p-2 border rounded">
            <option value="appartement">Appartement</option>
            <option value="benedenwoning">Benedenwoning</option>
            <option value="bovenwoning">Bovenwoning</option>
            <option value="tussenwoning" selected>Tussenwoning</option>
            <option value="hoekwoning">Hoekwoning</option>
            <option value="twee_onder_een_kap">2-onder-1-kap</option>
            <option value="vrijstaand">Vrijstaand</option>
          </select>
        </div>

        <!-- Woonoppervlakte -->
        <div>
          <label class="input-label">Woonoppervlakte (m¬≤)</label>
          <input id="input-size" type="number" class="w-full p-2 border rounded" placeholder="Bijv. 85">
        </div>

        <!-- Kamers -->
        <div>
          <label class="input-label">Aantal kamers</label>
          <input id="input-rooms" type="number" class="w-full p-2 border rounded" placeholder="Bijv. 3">
        </div>

        <!-- Energielabel -->
        <div>
          <label class="input-label">Energielabel</label>
          <select id="input-label" class="w-full p-2 border rounded">
            <option value="A+++">A+++</option>
            <option value="A++">A++</option>
            <option value="A+">A+</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C" selected>C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="?">Onbekend</option>
          </select>
        </div>

        <!-- Vraagprijs optioneel -->
        <div>
          <label class="input-label">(Optioneel) Vraagprijs</label>
          <input id="input-price" type="number" class="w-full p-2 border rounded" placeholder="Bijv. 395000">
        </div>

      </div>

      <!-- GEAVANCEERDE FACTOREN -->
      <div class="mt-6 border-t pt-4">

        <button id="toggle-adv"
          class="w-full flex items-center justify-between text-left font-semibold text-gray-700 mb-3">
          <span>‚öôÔ∏è Geavanceerde woningfactoren</span>
          <span id="adv-icon">‚ñº</span>
        </button>

        <div id="adv-fields" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">

          <!-- Bouwjaar -->
          <div>
            <label class="input-label">Bouwjaar</label>
            <select id="input-year" class="w-full p-2 border rounded">
              <option value="">Onbekend</option>
              <option value="1920">Voor 1930</option>
              <option value="1950">1930‚Äì1970</option>
              <option value="1980">1970‚Äì1990</option>
              <option value="1995">1990‚Äì2000</option>
              <option value="2005">2000‚Äì2010</option>
              <option value="2015">2010‚Äì2020</option>
              <option value="2023">> 2020</option>
            </select>
          </div>

          <!-- Onderhoudsstaat -->
          <div>
            <label class="input-label">Onderhoud / Afwerking</label>
            <select id="input-condition" class="w-full p-2 border rounded">
              <option value="normaal" selected>Normaal</option>
              <option value="slecht">Slecht</option>
              <option value="matig">Matig</option>
              <option value="goed">Goed</option>
              <option value="luxe">Luxe</option>
              <option value="zeer_luxe">Zeer luxe</option>
            </select>
          </div>

          <!-- Buitenruimte -->
          <div>
            <label class="input-label">Buitenruimte</label>
            <select id="input-outdoor" class="w-full p-2 border rounded">
              <option value="geen" selected>Geen</option>
              <option value="balkon">Balkon</option>
              <option value="dakterras">Dakterras</option>
              <option value="tuin_klein">Tuin (klein)</option>
              <option value="tuin_groot">Tuin (groot)</option>
            </select>
          </div>

          <!-- Grondsituatie -->
          <div>
            <label class="input-label">Grondsituatie</label>
            <select id="input-lease" class="w-full p-2 border rounded">
              <option value="eigen" selected>Eigen grond</option>
              <option value="erfpacht_canon">Erfpacht (canon)</option>
              <option value="erfpacht_afgekocht">Erfpacht afgekocht</option>
            </select>
          </div>

          <!-- Servicekosten -->
          <div>
            <label class="input-label">Servicekosten p/m</label>
            <input id="input-service" type="number"
                   placeholder="Bijv. 150"
                   class="w-full p-2 border rounded">
          </div>

          <!-- VvE kwaliteit -->
          <div>
            <label class="input-label">VvE kwaliteit</label>
            <select id="input-vve" class="w-full p-2 border rounded">
              <option value="">Onbekend</option>
              <option value="slecht">Slecht</option>
              <option value="matig">Matig</option>
              <option value="redelijk">Redelijk</option>
              <option value="goed" selected>Goed</option>
              <option value="uitstekend">Uitstekend</option>
            </select>
          </div>

        </div>
      </div>

      <button id="btn-calc"
        class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded text-lg font-semibold">
        Analyseer woning
      </button>

      <div id="user-output" class="mt-6 text-gray-800 text-sm"></div>

      <!-- RADAR CHART ‚Äì factor impact -->
<div class="mt-6">
    <h2 class="text-lg font-semibold mb-3">Impact per factor</h2>
    <canvas id="chart-radar" height="180"></canvas>
  </div>
  
    </div>

    <!-- TABS -->
    <div class="bg-white shadow rounded">      
      <div class="flex border-b flex-wrap">
      
        <button data-tab="overview" class="tab-btn px-6 py-3 border-b-2 border-blue-600 text-blue-600">
          Overzicht
        </button>

        <button data-tab="prices" class="tab-btn px-6 py-3 text-gray-600">
          Prijzen
        </button>

        <button data-tab="details" class="tab-btn px-6 py-3 text-gray-600">
          Details
        </button>

        <button data-tab="heatmap" class="tab-btn px-6 py-3 text-gray-600">
          Heatmap
        </button>

        <button data-tab="labels" class="tab-btn px-6 py-3 text-gray-600">
          Energielabels
        </button>

        <button data-tab="trend" class="tab-btn px-6 py-3 text-gray-600">
          Trend
        </button>
      
      </div>

      <!-- TAB CONTENT -->
      <div class="p-6">

        <!-- OVERZICHT -->
        <div id="tab-overview">
          <h2 class="text-lg font-semibold mb-4">Verdeling prijs per m¬≤</h2>
          <canvas id="chart-m2ranges" height="120"></canvas>
        </div>

        <!-- PRIJZEN -->
        <div id="tab-prices" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Prijs vs. woonoppervlakte</h2>
          <canvas id="chart-scatter" height="140"></canvas>
        </div>

        <!-- DETAILS -->
        <div id="tab-details" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Detailoverzicht</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded shadow">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-left">Adres</th>
                  <th class="px-4 py-2 text-left">Prijs</th>
                  <th class="px-4 py-2 text-left">m¬≤</th>
                  <th class="px-4 py-2 text-left">‚Ç¨/m¬≤</th>
                  <th class="px-4 py-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- HEATMAP -->
        <div id="tab-heatmap" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Heatmap: Prijs per m¬≤ per aantal kamers</h2>
          <canvas id="chart-heatmap" height="200"></canvas>
        </div>

        <!-- LABELS -->
        <div id="tab-labels" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Gemiddelde prijs per m¬≤ per energielabel</h2>
          <canvas id="chart-labels" height="120"></canvas>
        </div>

        <!-- TREND -->
        <div id="tab-trend" class="hidden">
          <h2 class="text-lg font-semibold mb-4">Vraagprijs Trend (gesimuleerd)</h2>
          <canvas id="chart-trend" height="120"></canvas>
        </div>

      </div>
    </div>

    <!-- INSIGHTS -->
    <div class="bg-white rounded shadow mt-6 p-6">
      <h3 class="text-lg font-semibold mb-4">üìä Belangrijkste inzichten</h3>
      <ul id="insights" class="space-y-2 text-gray-700 text-sm"></ul>
    </div>
      
    <!-- AI WAARDERING -->
    <div class="bg-white rounded shadow mt-6 p-6">
      <h3 class="text-lg font-semibold mb-4">ü§ñ Marktwaardeschatting</h3>
      <p id="ai-valuation" class="text-gray-800 text-sm"></p>
    </div>

  </div>



  <script>
    /* =========================================================================
       1. FUNDA SCRAPER ‚Äì API AANROEP (Render.com)
       ========================================================================= */
    
    async function fetchFundaData() {
      const urlInput = document.getElementById("funda-url");
      const loader   = document.getElementById("scrape-loader");
      const statusEl = document.getElementById("scrape-status");
    
      const fundaUrl = urlInput.value.trim();
      if (!fundaUrl) {
        alert("Voer een geldige Funda URL in.");
        return;
      }
    
      loader.classList.remove("hidden");
      statusEl.innerHTML = "";
    
      try {
        const apiUrl = "https://scraper-api-wxfu.onrender.com/scrape?url=" + encodeURIComponent(fundaUrl);
        const res = await fetch(apiUrl);
    
        if (!res.ok) throw new Error("API error: " + res.status);
    
        const data = await res.json();
        loader.classList.add("hidden");
    
        if (!Array.isArray(data) || data.length === 0) {
          statusEl.innerHTML = "‚ùå Geen resultaten gevonden.";
          return;
        }
    
        statusEl.innerHTML = `‚úÖ ${data.length} woningen geladen`;
    
        // Globale properties vullen met nette waarden
        window.properties = data.map(p => ({
          address:  p.address || "Onbekend",
          price:    Number(String(p.price || "0").replace(/\D+/g, "")) || 0,
          size:     Number(p.m2 || 0),
          rooms:    Number(p.bedrooms || 0),
          label:    p.energy_label || "?",
          status:   "Actief"
        }));
    
        // UI opnieuw opbouwen
        rebuildAllChartsAndTables();
    
      } catch (err) {
        loader.classList.add("hidden");
        statusEl.innerHTML = "‚ùå Fout bij laden: " + err.message;
      }
    }
    
    document.getElementById("btn-scrape").onclick = fetchFundaData;
    
    
    /* =========================================================================
       2. GLOBALE DATA-CONTAINER (LEEG BIJ START)
       ========================================================================= */
    let properties = [];   // pas gevuld NA scraping ‚Üí goed!
    
    
    /* =========================================================================
       3. HELPER FUNCTIES
       ========================================================================= */
    
    function calcAvg(arr) {
      return arr.length ? Math.round(arr.reduce((s,v)=>s+v,0) / arr.length) : 0;
    }
    
    function buildScatter(highlight = null) {
      if (window.chartScatter) window.chartScatter.destroy();
    
      const propsWithM2 = properties
        .filter(p => p.size > 0)
        .map(p => ({ ...p, pricePerM2: Math.round(p.price / p.size) }));
    
      const points = propsWithM2.map(p => ({
        x: p.size,
        y: p.price,
        address: p.address
      }));
    
      const datasets = [{
        label: "Overige woningen",
        data: points,
        pointRadius: 5,
        backgroundColor: "#8884d8"
      }];
    
      if (highlight) {
        datasets.push({
          label: "Jouw woning",
          data: [highlight],
          pointRadius: 9,
          backgroundColor: "red"
        });
      }
    
      window.chartScatter = new Chart(
        document.getElementById("chart-scatter"),
        {
          type: "scatter",
          data: { datasets },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const d = ctx.raw;
                    return `${d.address || "Jouw woning"}: ${d.x} m¬≤ ‚Äì ‚Ç¨${d.y.toLocaleString()}`;
                  }
                }
              }
            },
            scales: {
              x: { title: { display: true, text: "Oppervlakte (m¬≤)" }},
              y: {
                title: { display: true, text: "Prijs (‚Ç¨)" },
                ticks: {
                  callback: value => "‚Ç¨" + (value / 1000).toFixed(0) + "k"
                }
              }
            }
          }
        }
      );
    }
  
/* =========================================================================
   4. ADVANCED SECTION TOGGLE
   ========================================================================= */

const toggleAdvBtn = document.getElementById("toggle-adv");
if (toggleAdvBtn) {
  toggleAdvBtn.onclick = () => {
    const box  = document.getElementById("adv-fields");
    const icon = document.getElementById("adv-icon");

    if (!box) return;

    const isHidden = box.classList.contains("hidden");

    if (isHidden) {
      box.classList.remove("hidden");
      if (icon) icon.textContent = "‚ñ≤";
    } else {
      box.classList.add("hidden");
      if (icon) icon.textContent = "‚ñº";
    }
  };
}


/* =========================================================================
   5. TAB SWITCHING
   ========================================================================= */

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    const tab = btn.dataset.tab;

    document.querySelectorAll(".tab-btn").forEach(b => {
      b.classList.remove("border-blue-600", "text-blue-600", "border-b-2");
      b.classList.add("text-gray-600");
    });

    btn.classList.add("border-b-2", "border-blue-600", "text-blue-600");

    document.querySelectorAll("[id^='tab-']").forEach(div =>
      div.classList.add("hidden")
    );

    document.getElementById("tab-" + tab).classList.remove("hidden");
  };
});


/* =========================================================================
   6. RADAR CHART (bij waarderingsmodel)
   ========================================================================= */

let radarChart;

function renderRadarChart(breakdown) {

  const labels = [];
  const deltas = [];

  breakdown.forEach((step, i) => {
    const prev = i === 0 ? step.waarde : breakdown[i - 1].waarde;
    const delta = ((step.waarde - prev) / prev) * 100;
    labels.push(step.stap);
    deltas.push(parseFloat(delta.toFixed(1)));
  });

  const ctx = document.getElementById("chart-radar");

  if (radarChart) radarChart.destroy();

  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        data: deltas,
        fill: true,
        backgroundColor: "rgba(37, 99, 235, 0.25)",
        borderColor: "rgba(37, 99, 235, 1)",
        pointBackgroundColor: "rgba(37, 99, 235, 1)"
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: {
        r: {
          ticks: {
            callback: v => v + "%",
            backdropColor: "transparent"
          }
        }
      }
    }
  });
}


/* =========================================================================
   7. AI TAXATIEMODEL ‚Äì High precision waardering
   ========================================================================= */

function calculateValueDetailed({
  size,
  rooms,
  label,
  bouwjaar,
  onderhoud,
  erfpacht,
  servicekosten,
  buitenruimte,
  woningType
}) {

  const breakdown = [];

  /* ---------- 1. START ---------- */
  let currentM2 = avgM2;
  if (!currentM2 || !isFinite(currentM2)) currentM2 = 4000;

  breakdown.push({
    stap: "Startwaarde (buurtgemiddelde)",
    factor: 1,
    waarde: Math.round(currentM2)
  });

  /* ---------- 2. WONINGTYPE ---------- */
  const typeFactors = {
    "appartement": 0.97,
    "benedenwoning": 1.00,
    "bovenwoning": 1.00,
    "tussenwoning": 1.02,
    "hoekwoning": 1.03,
    "twee_onder_een_kap": 1.04,
    "vrijstaand": 1.06
  };

  const fType = typeFactors[woningType] || 1;
  currentM2 *= fType;

  if (fType !== 1) {
    breakdown.push({
      stap: `Woningtype (${woningType})`,
      factor: fType,
      waarde: Math.round(currentM2)
    });
  }

  /* ---------- 3. GROOTTE-EFFECT ---------- */
  const refSize = 85;
  const sizeFactor = Math.pow((refSize / size), 0.15);

  currentM2 *= sizeFactor;
  breakdown.push({
    stap: `Grootte-correctie (${size} m¬≤)`,
    factor: sizeFactor,
    waarde: Math.round(currentM2)
  });

  /* ---------- 4. BOUWJAAR ---------- */
  let fYear = 1;
  if (bouwjaar >= 2020) fYear = 1.08;
  else if (bouwjaar >= 2010) fYear = 1.05;
  else if (bouwjaar >= 2000) fYear = 1.02;
  else if (bouwjaar >= 1990) fYear = 1.00;
  else if (bouwjaar >= 1970) fYear = 0.94;
  else if (bouwjaar >= 1930) fYear = 0.97;
  else fYear = 0.92;

  currentM2 *= fYear;

  breakdown.push({
    stap: `Bouwjaar (${bouwjaar})`,
    factor: fYear,
    waarde: Math.round(currentM2)
  });

  /* ---------- 5. ENERGIELABEL ---------- */
  const labelMap = {
    "A+++": 1.06, "A++": 1.05, "A+": 1.04, "A": 1.03,
    "B": 1.00, "C": 0.97, "D": 0.93, "E": 0.90, "F": 0.86, "G": 0.82
  };

  let fLabel = labelMap[label] || 0.96;

  if (bouwjaar >= 2010 && ["A", "A+", "A++", "A+++"].includes(label)) {
    fLabel = 1.005;
  }

  currentM2 *= fLabel;

  breakdown.push({
    stap: `Energielabel (${label})`,
    factor: fLabel,
    waarde: Math.round(currentM2)
  });

  /* ---------- 6. ONDERHOUD ---------- */
  const maintMap = {
    "slecht": 0.82,
    "matig": 0.92,
    "normaal": 1.00,
    "goed": 1.03,
    "luxe": 1.06,
    "zeer_luxe": 1.09
  };

  const fMaint = maintMap[onderhoud] || 1;
  currentM2 *= fMaint;

  breakdown.push({
    stap: `Staat van onderhoud (${onderhoud})`,
    factor: fMaint,
    waarde: Math.round(currentM2)
  });

  /* ---------- 7. INDELING ---------- */
  let fRooms = 1;
  if (rooms / size > 0.08) fRooms = 0.98;
  else if (rooms >= 4) fRooms = 1.02;
  else if (rooms <= 2 && size > 80) fRooms = 0.97;

  currentM2 *= fRooms;

  if (fRooms !== 1) {
    breakdown.push({
      stap: `Indeling (${rooms} kamers)`,
      factor: fRooms,
      waarde: Math.round(currentM2)
    });
  }

  /* ---------- 8. TUSSENWAARDE ---------- */
  let estimatedPrice = currentM2 * size;

  /* ---------- 9. BUITENRUIMTE ---------- */
  const outdoorFactors = {
    "geen": 0,
    "balkon": 0.03,
    "dakterras": 0.05,
    "tuin_klein": 0.07,
    "tuin_groot": 0.12
  };

  let outdoorPct = outdoorFactors[buitenruimte] || 0;
  let outdoorValue = estimatedPrice * outdoorPct;

  const maxOutdoorValue = 65000;
  if (outdoorValue > maxOutdoorValue) outdoorValue = maxOutdoorValue;

  estimatedPrice += outdoorValue;

  const m2WithOutdoor = estimatedPrice / size;

  if (outdoorValue > 0) {
    breakdown.push({
      stap: `Buitenruimte (${buitenruimte})`,
      factor: m2WithOutdoor / currentM2,
      waarde: Math.round(m2WithOutdoor)
    });
  }

  currentM2 = m2WithOutdoor;

  /* ---------- 10. FINANCI√ãLE FACTOREN ---------- */
  let fFinancial = 1;

  if (erfpacht === "erfpacht_canon") fFinancial *= 0.90;
  if (erfpacht === "erfpacht_afgekocht") fFinancial *= 0.98;
  if (servicekosten > 250) fFinancial *= 0.96;

  currentM2 *= fFinancial;
  estimatedPrice *= fFinancial;

  if (fFinancial !== 1) {
    breakdown.push({
      stap: `Financi√´le correcties (Erfpacht/VvE)`,
      factor: fFinancial,
      waarde: Math.round(currentM2)
    });
  }

  /* ---------- 11. ONZEKERHEID ---------- */
  const finalPrice = Math.round(estimatedPrice);
  const finalM2 = Math.round(finalPrice / size);

  let uncertainty = 0.05;
  if (bouwjaar < 1920) uncertainty += 0.025;
  if (size > 180) uncertainty += 0.03;
  if (onderhoud === "slecht") uncertainty += 0.04;

  const low  = Math.round(finalPrice * (1 - uncertainty));
  const high = Math.round(finalPrice * (1 + uncertainty));

  return {
    m2: finalM2,
    price: finalPrice,
    low,
    high,
    breakdown,
    uncertaintyPct: (uncertainty * 100).toFixed(1)
  };
}


/* =========================================================================
   8. BUTTON ‚Üí UI OPBOUW VOOR TAXATIE RESULTAAT
   ========================================================================= */

document.getElementById("btn-calc").onclick = () => {

  const s  = Number(document.getElementById("input-size").value);
  const r  = Number(document.getElementById("input-rooms").value);
  const l  = document.getElementById("input-label").value;
  const bouwjaar      = Number(document.getElementById("input-year").value || 1990);
  const onderhoud     = document.getElementById("input-condition").value;
  const erfpacht      = document.getElementById("input-lease").value;
  const servicekosten = Number(document.getElementById("input-service").value || 0);
  const buitenruimte  = document.getElementById("input-outdoor").value;
  const woningType    = document.getElementById("input-type").value;

  if (!s) {
    alert("Voer minimaal woonoppervlakte in!");
    return;
  }

  const result = calculateValueDetailed({
    size: s, rooms: r, label: l,
    bouwjaar, onderhoud, erfpacht,
    servicekosten, buitenruimte,
    woningType
  });

  // Scatter highlight
  buildScatter({ x: s, y: result.price, address: "Jouw woning" });

  // Totale afwijking
  const totaleFactor   = avgM2 ? (result.m2 / avgM2) : 1;
  const totaleFactorPct = ((totaleFactor - 1) * 100).toFixed(1);
  const deltaSign      = totaleFactorPct >= 0 ? "+" : "";

  // HTML Resultaat
  document.getElementById("user-output").innerHTML = `
    <div class="bg-white border rounded p-4 space-y-4 shadow-sm">

      <h3 class="font-semibold text-lg mb-1 flex items-center gap-2">
        <span>üè°</span> Realistische Marktwaarde Indicatie
      </h3>

      <div class="bg-blue-50 border border-blue-100 rounded p-3 text-sm text-blue-900">
        <p>
          Op basis van een <strong>${woningType}</strong> van ${s} m¬≤ in deze buurt.
          Correcties toegepast op grootte, bouwjaar, label,
          onderhoud, indeling, buitenruimte en financi√´le lasten.
        </p>
      </div>

      <!-- Breakdown -->
      <div>
        <h4 class="font-semibold mb-2 text-xs uppercase tracking-wide text-gray-500">1. Waardebepaling per factor</h4>
        <div class="overflow-x-auto rounded border border-gray-200">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 text-gray-600">
              <tr>
                <th class="px-3 py-2 text-left">Factor</th>
                <th class="px-3 py-2 text-right">Impact</th>
                <th class="px-3 py-2 text-right">‚Ç¨/m¬≤</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              ${result.breakdown.map((step, idx) => {
                const prev = idx === 0 ? avgM2 : result.breakdown[idx - 1].waarde;
                const rawDelta = prev ? ((step.waarde - prev) / prev) * 100 : 0;
                const color =
                  rawDelta > 0 ? "text-emerald-600"
                : rawDelta < 0 ? "text-red-600"
                : "text-gray-400";

                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2">${step.stap}</td>
                    <td class="px-3 py-2 text-right font-medium ${color}">${rawDelta.toFixed(1)}%</td>
                    <td class="px-3 py-2 text-right">‚Ç¨${step.waarde.toLocaleString()}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Som -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="p-3 bg-gray-50 rounded border border-gray-200">
          <h4 class="font-semibold text-xs uppercase text-gray-500 mb-2">2. De Som</h4>
          <div class="text-sm space-y-1 font-mono text-gray-700">
            <div class="flex justify-between"><span>Oppervlakte:</span><span>${s} m¬≤</span></div>
            <div class="flex justify-between"><span>Gecorrigeerde m¬≤-prijs:</span><span>‚Ç¨${result.m2.toLocaleString()}/m¬≤</span></div>
            <div class="border-t my-1"></div>
            <div class="flex justify-between font-bold text-gray-900 text-base">
              <span>Taxatiewaarde:</span><span>‚Ç¨${result.price.toLocaleString()}</span>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">
            Dit is ${deltaSign}${totaleFactorPct}% t.o.v. de gemiddelde buurtprijs per m¬≤.
          </p>
        </div>

        <div class="p-3 bg-indigo-50 rounded border border-indigo-100">
          <h4 class="font-semibold text-xs uppercase text-indigo-800 mb-2">3. Betrouwbaarheid</h4>
          <p class="text-sm text-indigo-900 mb-2">
            Geschatte meetonnauwkeurigheid: <strong>¬±${result.uncertaintyPct}%</strong>.
          </p>
          <div class="text-center bg-white rounded py-2 px-3 border shadow-sm">
            <span class="block text-xs text-gray-500">Bandbreedte</span>
            <span class="font-bold text-indigo-700 text-lg">
              ‚Ç¨${result.low.toLocaleString()} ‚Äì ‚Ç¨${result.high.toLocaleString()}
            </span>
          </div>
        </div>
      </div>
    </div>
  `;

  // Radar chart bijwerken
  renderRadarChart(result.breakdown);

  // Sidebar update (optioneel)
  const sideVal = document.getElementById("ai-valuation");
  if (sideVal) {
    sideVal.innerHTML = `
      <strong>Geschatte waarde:</strong><br>
      <span class="text-xl">‚Ç¨${result.price.toLocaleString()}</span><br>
      <span class="text-xs text-gray-500">
        Bandbreedte: ‚Ç¨${result.low.toLocaleString()} ‚Äì ‚Ç¨${result.high.toLocaleString()}
      </span>
    `;
  }
};

/* =========================================================================
   9. REBUILD ALL ‚Äì na Funda scrape of handmatige refresh
   ========================================================================= */

function rebuildAllChartsAndTables() {
  console.log("üîÑ UI volledig opnieuw opbouwen‚Ä¶");

  if (!properties || !properties.length) {
    console.warn("‚ö†Ô∏è Geen properties om te verwerken");
    return;
  }

  /* ---------------------------------------------
     1. M2-prijzen opnieuw berekenen
  --------------------------------------------- */
  const propsWithM2 = properties
    .filter(p => p.size > 0)
    .map(p => ({
      ...p,
      pricePerM2: Math.round(p.price / p.size)
    }));

  const avg = arr =>
    arr.length ? Math.round(arr.reduce((s, v) => s + v, 0) / arr.length) : 0;

  window.avgM2    = avg(propsWithM2.map(p => p.pricePerM2));
  window.avgPrice = avg(propsWithM2.map(p => p.price));
  window.avgSize  = avg(propsWithM2.map(p => p.size));
  window.minM2    = Math.min(...propsWithM2.map(p => p.pricePerM2));
  window.maxM2    = Math.max(...propsWithM2.map(p => p.pricePerM2));

  /* ---------------------------------------------
     2. KPI kaarten opnieuw tekenen
  --------------------------------------------- */
  document.getElementById("kpis").innerHTML = `
    <div class="bg-white p-6 shadow rounded">
      <p class="text-sm text-gray-600">Gemiddelde prijs/m¬≤</p>
      <p class="text-2xl font-bold text-blue-600">‚Ç¨${avgM2.toLocaleString()}</p>
    </div>
    <div class="bg-white p-6 shadow rounded">
      <p class="text-sm text-gray-600">Gemiddelde prijs</p>
      <p class="text-2xl font-bold text-green-600">‚Ç¨${avgPrice.toLocaleString()}</p>
    </div>
    <div class="bg-white p-6 shadow rounded">
      <p class="text-sm text-gray-600">Gem. oppervlakte</p>
      <p class="text-2xl font-bold text-purple-600">${avgSize} m¬≤</p>
    </div>
  `;

  /* ---------------------------------------------
     3. Details tabel opnieuw vullen
  --------------------------------------------- */
  const tb = document.getElementById("table-body");
  tb.innerHTML = "";

  propsWithM2
    .slice() 
    .sort((a, b) => b.pricePerM2 - a.pricePerM2)
    .forEach(p => {
      tb.innerHTML += `
        <tr class="border-b">
          <td class="px-4 py-2">${p.address}</td>
          <td class="px-4 py-2">‚Ç¨${p.price.toLocaleString()}</td>
          <td class="px-4 py-2">${p.size}</td>
          <td class="px-4 py-2 font-bold text-blue-600">‚Ç¨${p.pricePerM2.toLocaleString()}</td>
          <td class="px-4 py-2">${p.status}</td>
        </tr>
      `;
    });

  /* ---------------------------------------------
     4. Insights opnieuw opbouwen
  --------------------------------------------- */
  const insights = document.getElementById("insights");
  insights.innerHTML = "";

  const soldCount = properties.filter(p => p.status === "Verkocht").length;
  const soldPct   = Math.round((soldCount / properties.length) * 100);

  const AplusCount = properties.filter(p => p.label && p.label.startsWith("A")).length;
  const AplusPct   = Math.round((AplusCount / properties.length) * 100);

  const addInsight = txt => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="text-blue-500 mr-2">‚Ä¢</span>${txt}`;
    insights.appendChild(li);
  };

  addInsight(`Gemiddelde prijs per m¬≤: <strong>‚Ç¨${avgM2.toLocaleString()}</strong>.`);
  addInsight(`${soldPct}% verkocht (${soldCount}/${properties.length}).`);
  addInsight(`m¬≤ prijs range: ‚Ç¨${minM2.toLocaleString()} ‚Äì ‚Ç¨${maxM2.toLocaleString()}.`);
  addInsight(`Energielabel A of hoger: ${AplusPct}%.`);

  /* ---------------------------------------------
     5. Oude grafieken vernietigen
  --------------------------------------------- */
  try { chartScatter?.destroy(); } catch(e) {}
  try { chartM2Ranges?.destroy(); } catch(e) {}
  try { chartHeatmap?.destroy(); } catch(e) {}
  try { chartLabels?.destroy(); } catch(e) {}
  try { chartTrend?.destroy(); } catch(e) {}

  /* ---------------------------------------------
     6. Scatter chart opnieuw tekenen
  --------------------------------------------- */
  buildScatter();

  /* ---------------------------------------------
     7. M¬≤ Range grafiek
  --------------------------------------------- */
  const ranges = [
    { label: "3000‚Äì4000", min: 3000, max: 4000, count: 0 },
    { label: "4000‚Äì5000", min: 4000, max: 5000, count: 0 },
    { label: "5000‚Äì6000", min: 5000, max: 6000, count: 0 },
    { label: "6000‚Äì7000", min: 6000, max: 7000, count: 0 },
    { label: "7000+",     min: 7000, max: 50000, count: 0 }
  ];

  propsWithM2.forEach(p => {
    const r = ranges.find(x => p.pricePerM2 >= x.min && p.pricePerM2 < x.max);
    if (r) r.count++;
  });

  chartM2Ranges = new Chart(document.getElementById("chart-m2ranges"), {
    type: "bar",
    data: {
      labels: ranges.map(r => r.label),
      datasets: [{
        data: ranges.map(r => r.count),
        backgroundColor: "#3b82f6"
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: { y: { beginAtZero: true }}
    }
  });

  /* ---------------------------------------------
     8. Heatmap ‚Äì prijs per m¬≤ vs aantal kamers
  --------------------------------------------- */
  const heat = {};
  propsWithM2.forEach(p => {
    if (!heat[p.rooms]) heat[p.rooms] = [];
    heat[p.rooms].push(p.pricePerM2);
  });

  const heatLabels = Object.keys(heat).sort((a, b) => a - b);
  const heatValues = heatLabels.map(k => avg(heat[k]));

  chartHeatmap = new Chart(document.getElementById("chart-heatmap"), {
    type: "bar",
    data: {
      labels: heatLabels.map(k => `${k} kamers`),
      datasets: [{
        data: heatValues,
        backgroundColor: heatValues.map(v => {
          const r = (v - minM2) / (maxM2 - minM2 || 1);
          return `rgb(${Math.round(255 * r)}, ${Math.round(255 * (1 - r))}, 80)`;
        })
      }]
    },
    options: { plugins: { legend: { display: false }}}
  });

  /* ---------------------------------------------
     9. Energielabel grafiek
  --------------------------------------------- */
  const groups = {};

  propsWithM2.forEach(p => {
    if (!p.label || p.label === "?") return;
    if (!groups[p.label]) groups[p.label] = [];
    groups[p.label].push(p.pricePerM2);
  });

  const labelNames = Object.keys(groups).sort();
  const labelAverages = labelNames.map(l => avg(groups[l]));

  chartLabels = new Chart(document.getElementById("chart-labels"), {
    type: "bar",
    data: {
      labels: labelNames,
      datasets: [{
        data: labelAverages,
        backgroundColor: "#10b981"
      }]
    },
    options: { plugins: { legend: { display: false }}}
  });

  /* ---------------------------------------------
     10. Trend grafiek
  --------------------------------------------- */
  const months = ["Jan","Feb","Mrt","Apr","Mei","Jun","Jul","Aug","Sep"];

  const trend = months.map(() =>
    avgPrice * (0.95 + Math.random() * 0.1)
  );

  chartTrend = new Chart(document.getElementById("chart-trend"), {
    type: "line",
    data: {
      labels: months,
      datasets: [{
        data: trend,
        borderColor: "#3b82f6",
        tension: 0.4
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: {
        y: {
          ticks: {
            callback: value => "‚Ç¨" + (value / 1000).toFixed(0) + "k"
          }
        }
      }
    }
  });

  console.log("‚úÖ UI volledig opnieuw opgebouwd!");
}
</script>


    

</body>
</html>
